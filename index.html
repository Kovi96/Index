<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ROI калькулятор (год) — только лицензии</title>
  <style>
    :root { font-family: Arial, sans-serif; }
    body { margin: 0; background: #f6f7fb; }
    .wrap { max-width: 860px; margin: 0 auto; padding: 20px; }
    .card { background: #fff; border-radius: 14px; padding: 16px; box-shadow: 0 6px 18px rgba(0,0,0,.06); }
    h1 { font-size: 18px; margin: 0 0 10px; }
    .grid { display: grid; gap: 12px; grid-template-columns: repeat(12, 1fr); }
    .col-12 { grid-column: span 12; }
    label { display: block; font-size: 12px; color: #444; margin-bottom: 6px; }
    input, select, button { width: 100%; padding: 10px; border-radius: 10px; border: 1px solid #d9dbe3; }
    input[type="number"] { appearance: textfield; }
    button { cursor: pointer; border: 0; background: #2f6fed; color: white; font-weight: 700; }
    button.secondary { background: #e9ecf5; color: #222; border: 1px solid #d9dbe3; }
    .small { font-size: 12px; color: #666; margin-top: 8px; }
    .kpi { display: grid; gap: 10px; grid-template-columns: repeat(2, 1fr); margin-top: 14px; align-items: stretch; }
    .kpi .box { background:#fafbff; border:1px solid #eef0f6; border-radius: 14px; padding: 12px; }
    .kpi .name { font-size: 12px; color:#555; }
    .kpi .val { font-size: 18px; font-weight: 800; margin-top: 6px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; overflow: hidden; border-radius: 12px; }
    .kpi-roi{grid-column: auto;}
    th, td { padding: 10px; border-bottom: 1px solid #eef0f6; text-align: left; vertical-align: middle; }
    th { font-size: 12px; color: #555; background: #fafbff; }
    .right { text-align: right; }
    .row-actions { display:flex; gap:10px; align-items: end; }
    .row-actions > div { flex: 1; }
    .dirty { color:#9a4b00; }
    @media (max-width: 720px){
      .kpi { grid-template-columns: 1fr; }
    }
  .hidden{display:none !important;}
    .hideCost{display:none !important;}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>ROI-калькулятор (год) — только лицензии</h1>

      <div class="grid">

        <div class="col-12">
          <label>Клиент (организация)</label>
          <input id="client" type="text" placeholder="Введите название организации" />
        </div>

        <div class="col-12">
          <label>Кол-во рабочих мест (РМ)</label>
          <input id="workplaces" type="number" min="0" placeholder="Введите кол-во РМ" />
        </div>
        <div class="col-12">
          <label>Лицензии (добавляй несколько)</label>
          <div class="row-actions">
            <div style="flex:2;">
              <select id="license"></select>
            </div>
            <div>
              <input id="qty" type="number" min="0" value="50" placeholder="Кол-во" />
            </div>
            <div style="width:180px; flex:0 0 180px;">
              <button id="addBtn" class="secondary" type="button">+ Добавить</button>
            </div>
          </div>

          <table>
            <thead>
              <tr>
                <th>Лицензия</th>
                <th class="right">Кол-во</th>
                <th class="right hideCost">Цена за 1/год</th>
                <th class="right hideCost">Итого/год</th>
                <th style="width:1%;"></th>
              </tr>
            </thead>
            <tbody id="listBody">
              <tr id="emptyRow"><td colspan="5" class="small">Пока ничего не добавлено. Выбери лицензию, укажи кол-во и нажми “Добавить”.</td></tr>
            </tbody>
          </table>

          <div class="small">
            <span id="dirtyNote" class="dirty" style="display:none;">Есть изменения — нажмите «Рассчитать ROI» ещё раз.</span>
          </div>
        </div>

        <div class="col-12">
          <button id="calcBtn" type="button">Рассчитать ROI</button>
        </div>
      </div>

      <div class="kpi">
        <div class="box hidden">
          <div class="name">Затраты на лицензии (₽/год)</div>
          <div class="val" id="kpiCurrent">—</div>
        </div>
        <div class="box">
          <div class="name">Потенциал экономии (₽/год)</div>
          <div class="val" id="kpiSavings">—</div>
        </div>
        <div class="box hidden">
          <div class="name">Инвестиции (₽/год)</div>
          <div class="val" id="kpiInvest">—</div>
        </div>
        <div class="box kpi-roi">
          <div class="name">ROI (%) / Окупаемость (лет)</div>
          <div class="val" id="kpiRoiPayback">—</div>
        </div>
      </div>

    </div>
  </div>

<script>

// ====== Lead capture (Google Sheets via Apps Script Web App) ======
const LEADS_ENDPOINT = "https://script.google.com/macros/s/AKfycbzY0v3ZZ1TAzTneF4NRmrP4j8RD6vJ3s6dxVMeZmWYUza_N6ZvoW-kFnA63ybhYbU_ExQ/exec"; // вставь сюда URL веб-приложения Apps Script

async function sendLead(payload){
  if (!LEADS_ENDPOINT) return;

  try{
    const body = JSON.stringify(payload);

    // 1) Самый надёжный способ для логирования без CORS: sendBeacon
    if (navigator && typeof navigator.sendBeacon === "function"){
      const blob = new Blob([body], { type: "text/plain;charset=utf-8" });
      const ok = navigator.sendBeacon(LEADS_ENDPOINT, blob);
      if (ok) return;
    }

    // 2) Fallback: fetch без CORS-проверки (запрос уйдёт, но ответа мы не читаем)
    await fetch(LEADS_ENDPOINT, {
      method: "POST",
      mode: "no-cors",
      body
    });
  }catch(e){
    // молча: не пугаем клиента
  }
}
// ================================================================

const LICENSE_CATALOG = [
  { id: "ms_office_m365", name: "Microsoft Office / Microsoft 365", pricePerYear: 12000 },
  { id: "ms_windows",      name: "Microsoft Windows (Pro/Enterprise)", pricePerYear: 8000 },
  { id: "adobe_acrobat",   name: "Adobe Acrobat Pro", pricePerYear: 18000 },
  { id: "adobe_cc",        name: "Adobe Creative Cloud", pricePerYear: 65000 },
  { id: "autocad",         name: "AutoCAD", pricePerYear: 120000 },
  { id: "1c",              name: "1С:Предприятие (пользовательская)", pricePerYear: 18000 },
  { id: "antivirus",       name: "Антивирус (Kaspersky/Dr.Web/аналог)", pricePerYear: 2500 },
  { id: "ms_visio",        name: "Microsoft Visio", pricePerYear: 15000 },
  { id: "ms_project",      name: "Microsoft Project", pricePerYear: 20000 },
  { id: "powerbi",         name: "Power BI Pro", pricePerYear: 12000 },
  { id: "zoom",            name: "Zoom (Pro/Business)", pricePerYear: 14000 },
  { id: "slack",           name: "Slack / корпоративный мессенджер", pricePerYear: 16000 },
  { id: "atlassian",       name: "Atlassian (Jira/Confluence)", pricePerYear: 30000 },
  { id: "jetbrains",       name: "JetBrains (IDE)", pricePerYear: 35000 },
  { id: "anydesk",         name: "AnyDesk / TeamViewer (удалённый доступ)", pricePerYear: 9000 },
  { id: "vmware",          name: "VMware (инфраструктура)", pricePerYear: 90000 },
  { id: "citrix",          name: "Citrix (виртуализация рабочих мест)", pricePerYear: 110000 },
  { id: "mssql",           name: "MS SQL Server (усреднённо)", pricePerYear: 200000 },
  { id: "oracle",          name: "Oracle DB (усреднённо)", pricePerYear: 250000 },
  { id: "sap",             name: "SAP (усреднённо)", pricePerYear: 300000 },
];

// Скрытые допущения (клиенту не показываем)
const OPTIMIZATION_PCT = 0.20; // экономия 20% от затрат на лицензии
// Чтобы ROI НЕ был константой, инвестиции считаем НЕ как % от суммы, а как базу + нагрузку от количества лицензий
const INVEST_BASE = 250000;     // базовая инвестиция, ₽/год
const INVEST_PER_LICENSE = 600; // ₽/год за 1 "единицу лицензии" (по кол-ву)

function fmtRub(n){
  if (!isFinite(n)) return "—";
  const rounded = Math.round(n);
  return rounded.toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ") + " ₽";
}
function fmtNum(n){
  if (!isFinite(n)) return "—";
  return (Math.round(n*10)/10).toString();
}

const kpiIds = ["kpiCurrent","kpiSavings","kpiInvest","kpiRoiPayback"];
function resetKpis(){
  for (const id of kpiIds) document.getElementById(id).textContent = "—";
}

let hasCalculated = false;
const dirtyNote = document.getElementById("dirtyNote");
function markDirty(){
  if (!hasCalculated) return;
  dirtyNote.style.display = "inline";
}
function clearDirty(){ dirtyNote.style.display = "none"; }

const sel = document.getElementById("license");
for (const item of LICENSE_CATALOG){
  const opt = document.createElement("option");
  opt.value = item.id;
  opt.textContent = item.name;
  sel.appendChild(opt);
}
sel.value = LICENSE_CATALOG[0].id;

function getItem(id){ return LICENSE_CATALOG.find(x => x.id === id); }

const listBody = document.getElementById("listBody");
const emptyRow = document.getElementById("emptyRow");
const selected = new Map();

function renderList(){
  listBody.innerHTML = "";
  if (selected.size === 0){
    listBody.appendChild(emptyRow);
    return;
  }

  for (const [licenseId, row] of selected.entries()){
    const tr = document.createElement("tr");

    const td1 = document.createElement("td");
    td1.textContent = row.name;

    const td2 = document.createElement("td");
    td2.className = "right";
    const qtyInput = document.createElement("input");
    qtyInput.type = "number";
    qtyInput.min = "0";
    qtyInput.value = String(row.qty);
    qtyInput.style.maxWidth = "140px";
    qtyInput.style.textAlign = "right";
    td2.appendChild(qtyInput);

    const td3 = document.createElement("td");
    td3.className = "right hideCost";
    td3.textContent = fmtRub(row.pricePerYear);

    const td4 = document.createElement("td");
    td4.className = "right hideCost";
    const totalSpan = document.createElement("span");
    totalSpan.textContent = fmtRub(row.qty * row.pricePerYear);
    td4.appendChild(totalSpan);

    const td5 = document.createElement("td");
    const delBtn = document.createElement("button");
    delBtn.type = "button";
    delBtn.className = "secondary";
    delBtn.textContent = "✕";
    delBtn.style.width = "44px";
    td5.appendChild(delBtn);

    qtyInput.addEventListener("input", () => {
      const q = Number(qtyInput.value || 0);
      const r = selected.get(licenseId);
      r.qty = q;
      selected.set(licenseId, r);
      totalSpan.textContent = fmtRub(q * r.pricePerYear);
      markDirty();
    });

    delBtn.addEventListener("click", () => {
      selected.delete(licenseId);
      renderList();
      markDirty();
    });

    tr.appendChild(td1);
    tr.appendChild(td2);
    tr.appendChild(td3);
    tr.appendChild(td4);
    tr.appendChild(td5);
    listBody.appendChild(tr);
  }
}

function addSelected(){
  const licenseId = sel.value;
  const qty = Number(document.getElementById("qty").value || 0);
  const item = getItem(licenseId);
  if (!item) return;

  const existing = selected.get(licenseId);
  const newQty = (existing ? existing.qty : 0) + qty;

  selected.set(licenseId, { name: item.name, pricePerYear: item.pricePerYear, qty: newQty });
  document.getElementById("qty").value = "0";

  renderList();
  markDirty();
}

function sumCurrentCost(){
  let total = 0;
  for (const r of selected.values()){
    total += (Number(r.qty || 0) * Number(r.pricePerYear || 0));
  }
  return total;
}
function sumTotalLicenses(){
  let totalQty = 0;
  for (const r of selected.values()){
    totalQty += Number(r.qty || 0);
  }
  return totalQty;
}


function buildLeadPayload(savings, roi, paybackYears){
  const client = (document.getElementById("client")?.value || "").trim();
  const workplaces = Number(document.getElementById("workplaces")?.value || 0);

  const licenses = [];
  let licensesTotalQty = 0;

  for (const r of selected.values()){
    const qty = Number(r.qty || 0);
    licensesTotalQty += qty;
    licenses.push({ name: r.name, qty });
  }

  const licensesText = licenses.map(x => `${x.name}: ${x.qty}`).join("; ");

  return {
    ts: new Date().toISOString(),
    client,
    workplaces,
    licenses,
    licensesText,
    licensesTotalQty,
    savingsRub: Math.round(savings || 0),
    roiPct: (isFinite(roi) ? Math.round(roi * 10) / 10 : null),
    paybackYears: (isFinite(paybackYears) ? Math.round(paybackYears * 10) / 10 : null),
  };
}


function calc(){
  const current = sumCurrentCost();                 // ₽/год
  const savings = current * OPTIMIZATION_PCT;       // ₽/год
  const totalLicenses = sumTotalLicenses();         // шт

  // Инвестиции зависят от количества лицензий (а не от суммы), поэтому ROI меняется
  const investment = INVEST_BASE + (totalLicenses * INVEST_PER_LICENSE);

  let roi = NaN;
  let paybackYears = NaN;
  if (investment > 0){
    roi = ((savings - investment) / investment) * 100;
    paybackYears = savings > 0 ? (investment / savings) : Infinity;
  }

  document.getElementById("kpiCurrent").textContent = fmtRub(current);
  document.getElementById("kpiSavings").textContent = fmtRub(savings);
  document.getElementById("kpiInvest").textContent = fmtRub(investment);
  document.getElementById("kpiRoiPayback").textContent =
    (isFinite(roi) ? (fmtNum(roi) + " %") : "—") + " / " +
    (isFinite(paybackYears) ? fmtNum(paybackYears) : (paybackYears === Infinity ? "∞" : "—"));

  // отправляем данные в Google Sheets (после клика «Рассчитать ROI»)
  const payload = buildLeadPayload(savings, roi, paybackYears);
  sendLead(payload);

  hasCalculated = true;
  clearDirty();
}

document.getElementById("addBtn").addEventListener("click", addSelected);
document.getElementById("calcBtn").addEventListener("click", calc);
document.getElementById("qty").addEventListener("keydown", (e) => { if (e.key === "Enter") addSelected(); });

resetKpis();
renderList();
</script>
</body>
</html>
